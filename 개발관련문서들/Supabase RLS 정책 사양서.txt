Supabase RLS ì •ì±… ì‚¬ì–‘ì„œ

ì™„ì „ ë§ì•„ìš”. **RLS ì •ì±…ì„ ë¬¸ì„œí™”**í•´ë‘ë©´ ë‚˜ì¤‘ì— ìˆ˜ì •Â·ë””ë²„ê¹…Â·í˜‘ì—…Â·ë³´ì•ˆë¦¬ë·°ê°€ ì••ë„ì ìœ¼ë¡œ í¸í•´ì§‘ë‹ˆë‹¤.
ë°”ë¡œ ê°€ì ¸ë‹¤ ì“¸ ìˆ˜ ìˆê²Œ \*\*â€œRLS ì •ì±… ì‚¬ì–‘ì„œ(í…œí”Œë¦¿ + SQL + ì ê²€ ì²´í¬ë¦¬ìŠ¤íŠ¸)â€\*\*ë¥¼ ë“œë¦´ê²Œìš”. ë³µë¶™í•´ì„œ ì €ì¥í•˜ê³  Gitì— ì˜¬ë¦¬ë©´ ë©ë‹ˆë‹¤.

---

# ğŸ“„ Supabase RLS ì •ì±… ì‚¬ì–‘ì„œ (í…œí”Œë¦¿)

> ì´ ë¬¸ì„œëŠ” ì˜ì–´ í•™ìŠµ SaaS MVPì˜ **í•µì‹¬ í…Œì´ë¸” êµ¬ì¡°**ì™€ **í•™ìŠµ ë£¨í”„**ì— ë§ì¶˜ RLS ì •ì±…ì„ ì •ë¦¬í•©ë‹ˆë‹¤. í…Œì´ë¸”/ë£¨í”„ëŠ” ê¸°íšì„œÂ·ì‚¬ì–‘ì„œ ê¸°ì¤€ì…ë‹ˆë‹¤. (í•µì‹¬ í…Œì´ë¸” 8ì¢… + ì„ íƒ concepts)
> ì¶œì œâ†’ì œì¶œâ†’ì±„ì â†’SRSâ†’ì„¸ì…˜ì™„ë£Œì˜ ëŸ°íƒ€ì„ ë£¨í”„ì—ì„œ ìŠ¤ëƒ…ìƒ· ê¸°ì¤€ ì±„ì ì´ í•µì‹¬ì…ë‹ˆë‹¤.

## 0) ë¬¸ì„œ ëª©ì 

* **ë³´ì•ˆ ì›ì¹™**: ì‚¬ìš©ìëŠ” **ìê¸° ë°ì´í„°ë§Œ** ì¡°íšŒ/ì‘ì„±, ìš´ì˜ í¸ì§‘ì€ **service\_role** ì „ìš©
* **ìš´ì˜ í¸ì˜**: ì •ì±… ë³€ê²½ ì´ë ¥ ê´€ë¦¬(ê¹ƒ), ì •ì±… ì˜ë„ì™€ SQLì˜ 1:1 ë§¤í•‘
* **í…ŒìŠ¤íŠ¸ ë°©ë²•**: ì¿¼ë¦¬ ì˜ˆì‹œ í¬í•¨(ì •ì±… ê²€ì¦)

---

## 1) ì ìš© ë²”ìœ„ (í…Œì´ë¸”)

* í•„ìˆ˜: `users`, `items`, `sessions`, `session_items`, `attempts`, `grades`, `user_item_status`, `user_concept_status`
* ì„ íƒ: `concepts` (ì„¤ëª…/ê²€ìƒ‰ í’ˆì§ˆ)

---

## 2) ê³µí†µ ì„¤ì • (RLS ON & enum í™•ì¸)

```sql
-- RLS í™œì„±í™”
alter table public.users enable row level security;
alter table public.items enable row level security;
alter table public.sessions enable row level security;
alter table public.session_items enable row level security;
alter table public.attempts enable row level security;
alter table public.grades enable row level security;
alter table public.user_item_status enable row level security;
alter table public.user_concept_status enable row level security;
alter table public.concepts enable row level security;

-- ì±„ì  í•¨ìˆ˜ì—ì„œ ì‚¬ìš©í•˜ëŠ” enum(ì—†ìœ¼ë©´ ìƒì„±)
do $$
begin
  if not exists (select 1 from pg_type where typname = 'grade_label') then
    create type grade_label as enum ('correct','variant','near_miss','wrong');
  end if;
  if not exists (select 1 from pg_type where typname = 'judge_type') then
    create type judge_type as enum ('rule','ai');
  end if;
end $$;
```

---

## 3) í…Œì´ë¸”ë³„ ì •ì±…

### 3.1 `items` (ë¬¸í•­ ì›ë³¸)

**ì˜ë„:** ì‚¬ìš©ìëŠ” ìŠ¹ì¸ëœ(`approved`) ë¬¸í•­ë§Œ ì¡°íšŒ. ì´ˆì•ˆ/ì•„ì¹´ì´ë¸ŒëŠ” **ìš´ì˜(ì„œë²„)** ì „ìš©. ì¶œì œ ì‹œì ì—ëŠ” `session_items.snapshot_json`ìœ¼ë¡œ **ë™ê²°**, ì±„ì Â·ë³µì›ì€ **ìŠ¤ëƒ…ìƒ· ê¸°ì¤€**.

```sql
-- ë¡œê·¸ì¸ ì‚¬ìš©ì: ìŠ¹ì¸ëœ ë¬¸í•­ë§Œ ì½ê¸°
create policy "items_select_approved_only"
on public.items
for select
to authenticated
using (status = 'approved');

-- ìš´ì˜/ê´€ë¦¬(ì½˜í…ì¸  í¸ì§‘/ë“±ë¡/ìŠ¹ê²©): service_role ì „ìš©
create policy "items_admin_full_access"
on public.items
for all
to service_role
using (true)
with check (true);
```

### 3.2 `sessions` (ì„¸ì…˜ ì»¨í…Œì´ë„ˆ)

**ì˜ë„:** ë³¸ì¸ ì„¸ì…˜ë§Œ ì ‘ê·¼ ê°€ëŠ¥.

```sql
create policy "sessions_rw_own"
on public.sessions
for all
to authenticated
using (user_id = auth.uid())
with check (user_id = auth.uid());
```

### 3.3 `session_items` (ì¶œì œ ìŠ¤ëƒ…ìƒ·)

**ì˜ë„:** ë³¸ì¸ ì„¸ì…˜ì˜ ìŠ¤ëƒ…ìƒ·ë§Œ ì½ê¸°, ì‚½ì…ì€ **í•¨ìˆ˜/ì„œë²„ ì „ìš©**(ì‚¬ìš©ì ì§ì ‘ insert ê¸ˆì§€). ìŠ¤ëƒ…ìƒ·ì€ ì±„ì ì˜ ìœ ì¼ ê¸°ì¤€.

```sql
-- ì½ê¸°: ë‚´ ì„¸ì…˜ì˜ ìŠ¤ëƒ…ìƒ·ë§Œ
create policy "session_items_r_own_session"
on public.session_items
for select
to authenticated
using (
  exists (
    select 1 from public.sessions s
    where s.id = session_items.session_id
      and s.user_id = auth.uid()
  )
);

-- ì‚½ì…: ì„œë²„/í•¨ìˆ˜ì—ì„œë§Œ
create policy "session_items_ins_server_only"
on public.session_items
for insert
to service_role
with check (true);
```

### 3.4 `attempts` (ì œì¶œ)

**ì˜ë„:** ë³¸ì¸ ì„¸ì…˜ì—ë§Œ ì œì¶œ ê°€ëŠ¥, ë³¸ì¸ ì„¸ì…˜ ì œì¶œë§Œ ì¡°íšŒ.

```sql
create policy "attempts_r_own_session"
on public.attempts
for select
to authenticated
using (
  exists (
    select 1 from public.sessions s
    where s.id = attempts.session_id
      and s.user_id = auth.uid()
  )
);

create policy "attempts_w_own_session"
on public.attempts
for insert
to authenticated
with check (
  exists (
    select 1 from public.sessions s
    where s.id = attempts.session_id
      and s.user_id = auth.uid()
  )
);
```

### 3.5 `grades` (ì±„ì )

**ì˜ë„:** ë³¸ì¸ attemptì— ëŒ€í•œ gradeë§Œ ì½ê¸°/ì‘ì„± ê°€ëŠ¥. ì´ˆê¸° ë²„ì „ì€ **ë£° ì±„ì ** ë™ê¸° ì €ì¥.

```sql
create policy "grades_r_own_attempt"
on public.grades
for select
to authenticated
using (
  exists (
    select 1 from public.attempts a
    join public.sessions s on s.id = a.session_id
    where a.id = grades.attempt_id
      and s.user_id = auth.uid()
  )
);

create policy "grades_w_own_attempt"
on public.grades
for insert
to authenticated
with check (
  exists (
    select 1 from public.attempts a
    join public.sessions s on s.id = a.session_id
    where a.id = grades.attempt_id
      and s.user_id = auth.uid()
  )
);
```

> **í–¥í›„** AI ë¹„ë™ê¸° í›„ì²˜ë¦¬ ì‹œì—ëŠ” service\_role insert ì •ì±…ì„ ì¶”ê°€í•˜ì„¸ìš”.

### 3.6 `user_item_status` / `user_concept_status` (ë¼ì´íŠ¸ë„ˆ)

**ì˜ë„:** ë³¸ì¸ ë°ì´í„°ë§Œ ì½ê¸°/ì“°ê¸°. ë¼ì´íŠ¸ë„ˆëŠ” ì±„ì  ê²°ê³¼ì— ë”°ë¼ ìë™ ê°±ì‹ .

```sql
create policy "user_item_status_rw_own"
on public.user_item_status
for all
to authenticated
using (user_id = auth.uid())
with check (user_id = auth.uid());

create policy "user_concept_status_rw_own"
on public.user_concept_status
for all
to authenticated
using (user_id = auth.uid())
with check (user_id = auth.uid());
```

### 3.7 `concepts` (ì„ íƒ)

**ì˜ë„:** ë¡œê·¸ì¸ ì‚¬ìš©ìëŠ” ì½ê¸° ê°€ëŠ¥, í¸ì§‘ì€ ìš´ì˜ ì „ìš©.

```sql
create policy "concepts_r_all_auth"
on public.concepts
for select
to authenticated
using (true);

create policy "concepts_admin_full"
on public.concepts
for all
to service_role
using (true)
with check (true);
```

### 3.8 `users`

**ì˜ë„:** ë³¸ì¸ í”„ë¡œí•„ë§Œ ì½ê¸°/ìˆ˜ì •.

```sql
create policy "users_rw_self"
on public.users
for all
to authenticated
using (id = auth.uid())
with check (id = auth.uid());
```

---

## 4) í•¨ìˆ˜ ë³´ì•ˆ (ì¶œì œâ†’ì œì¶œâ†’ì±„ì â†’SRSâ†’ì™„ë£Œ)

**ì˜ë„:** ì¼ë¶€ í…Œì´ë¸” insertë¥¼ ì‚¬ìš©ìì—ê²Œ ì§ì ‘ ì—´ì–´ë‘ì§€ ì•Šê³ , **í•¨ìˆ˜ë¡œë§Œ ìˆ˜í–‰**(SECURITY DEFINER). ì‚¬ìš©ìëŠ” í•¨ìˆ˜ ì‹¤í–‰ ê¶Œí•œë§Œ ê°€ì§. ë£¨í”„ìš© í•¨ìˆ˜ëŠ” ì‚¬ì–‘ì„œì™€ 1:1 ë§¤í•‘.

```sql
-- SECURITY DEFINER + search_path ê³ ì • + ì‹¤í–‰ê¶Œí•œ
alter function public.start_session(uuid, int) security definer set search_path = public;
alter function public.submit_attempt(uuid, uuid, text, int) security definer set search_path = public;
alter function public.save_grade(uuid, grade_label, text, text, text[], judge_type, jsonb) security definer set search_path = public;
alter function public.update_srs(uuid) security definer set search_path = public;
alter function public.complete_session(uuid) security definer set search_path = public;

grant execute on function public.start_session(uuid, int) to authenticated;
grant execute on function public.submit_attempt(uuid, uuid, text, int) to authenticated;
grant execute on function public.save_grade(uuid, grade_label, text, text, text[], judge_type, jsonb) to authenticated;
grant execute on function public.update_srs(uuid) to authenticated;
grant execute on function public.complete_session(uuid) to authenticated;
```

---

## 5) ì¸ë±ìŠ¤ (ê¶Œì¥)

ë£¨í”„/ëŒ€ì‹œë³´ë“œ ì¡°íšŒ ê¸°ì¤€ì— ë§ì¶˜ ì¸ë±ìŠ¤.

```sql
create index if not exists idx_sessions_user_status on public.sessions(user_id, status);
create index if not exists idx_session_items_session_order on public.session_items(session_id, order_index);
create index if not exists idx_attempts_session_item on public.attempts(session_id, item_id);
create index if not exists idx_grades_attempt on public.grades(attempt_id);
create index if not exists idx_user_item_status_next_due on public.user_item_status(user_id, next_due_at);
create index if not exists idx_user_concept_status_next_due on public.user_concept_status(user_id, next_due_at);
```

---

## 6) ì ê²€(ê²€ì¦) ì‹œë‚˜ë¦¬ì˜¤

* **ì„¸ì…˜ ì‹œì‘ â†’ ìŠ¤ëƒ…ìƒ· ìƒì„±**: `start_session()` í˜¸ì¶œ í›„ `session_items`ì— insert ë˜ì—ˆëŠ”ì§€ í™•ì¸ (ì‚¬ìš©ìëŠ” ì§ì ‘ insert ê¶Œí•œ ì—†ìŒ)
* **ì œì¶œ/ì±„ì **: ë‚´ ì„¸ì…˜ì—ë§Œ ì œì¶œ/ì±„ì  insert ê°€ëŠ¥, íƒ€ ì‚¬ìš©ì ì„¸ì…˜ì´ë©´ ê±°ë¶€ë˜ì–´ì•¼ í•¨
* **SRS ê°±ì‹  & ì¡°íšŒ**: ë³¸ì¸ user\_idì— ëŒ€í•´ì„œë§Œ read/write ê°€ëŠ¥

ìƒ˜í”Œ ì¿¼ë¦¬(ì•„ì´ë””ëŠ” í…ŒìŠ¤íŠ¸ ê°’ìœ¼ë¡œ ì¹˜í™˜):

```sql
select start_session(auth.uid(), 3) as new_session;
-- ë‚´ ì„¸ì…˜ ìŠ¤ëƒ…ìƒ·ë§Œ ë³´ì´ëŠ”ì§€
select count(*) from session_items si
join sessions s on s.id = si.session_id
where s.user_id = auth.uid();

-- ë‚¨ì˜ ì„¸ì…˜ ì‹œë„ â†’ 0í–‰/ê±°ë¶€ê°€ ì •ìƒ
select * from attempts a
join sessions s on s.id = a.session_id
where s.user_id <> auth.uid();
```

user_level_history í…Œì´ë¸”ì— RLS(Row Level Security)ë¥¼ ì§€ì •í•˜ëŠ” ë°©ë²•ì„ ë‹¨ê³„ë³„ë¡œ ì •ë¦¬
ì¼ë°˜ ì‚¬ìš©ì â†’ ìê¸° ë ˆë²¨ ì´ë ¥ë§Œ ì½ê³ (insert ê°€ëŠ¥)
ê´€ë¦¬ì(users.role='admin') â†’ ëª¨ë“  ì‚¬ìš©ì ì´ë ¥ ì¡°íšŒ/ì¶”ê°€ ê°€ëŠ¥
service_role â†’ ì „ì²´ ì¡°ì‘ ê°€ëŠ¥

```sql
-- ğŸ”¹ user_level_history í…Œì´ë¸” ìƒì„±
create table if not exists public.user_level_history (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references public.users(id) on delete cascade,
  level int not null,
  source text not null,                      -- ë³€ê²½ ê·¼ê±°: onboarding | auto_assessment | manual_override
  changed_at timestamp not null default now()
);

-- ğŸ”¹ RLS í™œì„±í™”
alter table public.user_level_history enable row level security;

-- ğŸ”¹ ì‚¬ìš©ì ì •ì±… (ë³¸ì¸ ì´ë ¥ë§Œ ì¡°íšŒ/ì¶”ê°€ ê°€ëŠ¥)
drop policy if exists "user_level_history_r_own" on public.user_level_history;
create policy "user_level_history_r_own"
on public.user_level_history
for select
to authenticated
using (user_id = auth.uid());

drop policy if exists "user_level_history_w_own" on public.user_level_history;
create policy "user_level_history_w_own"
on public.user_level_history
for insert
to authenticated
with check (user_id = auth.uid());

-- ğŸ”¹ ê´€ë¦¬ì ì •ì±… (ì „ì²´ ì¡°íšŒ/ì¶”ê°€ ê°€ëŠ¥)
drop policy if exists "user_level_history_r_admin" on public.user_level_history;
create policy "user_level_history_r_admin"
on public.user_level_history
for select
to authenticated
using (
  exists (
    select 1 from public.users u
    where u.id = auth.uid()
      and u.role = 'admin'
  )
);

drop policy if exists "user_level_history_w_admin" on public.user_level_history;
create policy "user_level_history_w_admin"
on public.user_level_history
for insert
to authenticated
with check (
  exists (
    select 1 from public.users u
    where u.id = auth.uid()
      and u.role = 'admin'
  )
);

-- ğŸ”¹ service_role ì „ìš©: ì „ì²´ ê¶Œí•œ í—ˆìš© (ìš´ì˜/ì„œë²„ í•¨ìˆ˜ìš©)
drop policy if exists "user_level_history_admin_full" on public.user_level_history;
create policy "user_level_history_admin_full"
on public.user_level_history
for all
to service_role
using (true)
with check (true);
```

---

