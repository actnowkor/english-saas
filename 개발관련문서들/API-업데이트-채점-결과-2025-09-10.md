# 채점/결과 API 업데이트 (2025-09-10)

본 문서는 기존 API 명세에 대한 보강 사항을 정리합니다. 기존 문서를 대체하지 않고, 변경·추가된 정책만을 담습니다.

## get_session_result (DB 함수)

- 집계 기준: 문항별 “가장 최근에 채점된 시도”를 우선 사용하고, 해당이 없으면 “가장 최근 시도”를 사용합니다.
- 반환 필드 확장: 각 item에 `attempt_id`, `submitted_at`, `latency_ms`가 추가됩니다(기존 `question`, `correct_answer`, `user_answer`, `label`, `feedback`, `minimal_rewrite`와 호환).
- 보안: SECURITY DEFINER 함수이므로 내부에서 `auth.uid()`로 세션 소유권을 검증합니다. 불일치 시 42501(Forbidden) 예외를 발생시킵니다.

## save_grade (DB 함수)

- 소유권 검증: `attempts → sessions.user_id`가 `auth.uid()`와 일치해야 저장할 수 있습니다.
- 타임스탬프: upsert 시 `created_at`은 최초 삽입에서만 설정하며 업데이트 시 보존합니다(원하면 `updated_at`을 별도 운영).
- 권한: `grant execute on function ... to authenticated` 유지.

## submit_attempt (권장 정책)

- 중복 시도 방지(권장): `(session_id, item_id)` 유니크 인덱스 추가 후, `submit_attempt`를 멱등 처리(기존 attempt_id 반환).
- 다중 시도 허용 시: 집계/결과/SRS에서 “가장 최근 채점된 시도”만 반영하도록 일관 규정.

## 채점 정규화 규칙(프런트/서버 공통)

- 사용자 입력은 모두 소문자로 변환하고, 문장부호/기호(.,!?;:"'`~@#%^&*()[]{}<>/\|+=_ - 등)를 공백으로 치환한 뒤, 연속 공백을 1칸으로 압축하여 비교합니다.
- 스냅샷 필드: `answer_en`, `allowed_variants_text`, `near_misses_text`를 기준으로 `correct | variant | near_miss | wrong` 판정합니다.

